{"version":3,"sources":["../src/router.ts"],"sourcesContent":["/**\n * Bot Router - Routes @mentions to appropriate bot handlers\n */\n\nimport type { LanguageModel } from 'ai';\n\nexport interface BotContext {\n    /** The full comment body */\n    body: string;\n    /** Extracted query (text after the @mention) */\n    query: string;\n    /** Issue or PR number */\n    number: number;\n    /** Whether this is a PR (vs issue) */\n    isPR: boolean;\n    /** Repository owner */\n    owner: string;\n    /** Repository name */\n    repo: string;\n    /** Comment author */\n    author: string;\n    /** AI model to use */\n    model?: LanguageModel;\n    /** GitHub token */\n    token?: string;\n}\n\nexport interface BotResponse {\n    /** Response body (markdown) */\n    body: string;\n    /** Whether to post as a new comment */\n    postComment?: boolean;\n    /** Labels to add */\n    addLabels?: string[];\n    /** Labels to remove */\n    removeLabels?: string[];\n    /** Assignees to add */\n    addAssignees?: string[];\n    /** Whether the bot handled the request */\n    handled: boolean;\n    /** Error message if any */\n    error?: string;\n}\n\nexport interface Bot {\n    /** Bot name (e.g., 'sage', 'curator') */\n    name: string;\n    /** Mention triggers (e.g., ['@sage', '/sage']) */\n    triggers: string[];\n    /** Handle a mention */\n    handle(ctx: BotContext): Promise<BotResponse>;\n}\n\n/**\n * Bot Registry and Router\n */\nexport class BotRouter {\n    private bots: Map<string, Bot> = new Map();\n\n    /**\n     * Register a bot\n     */\n    register(bot: Bot): void {\n        this.bots.set(bot.name, bot);\n    }\n\n    /**\n     * Find the bot that should handle this comment\n     */\n    findBot(body: string): Bot | undefined {\n        const lowerBody = body.toLowerCase();\n\n        for (const bot of this.bots.values()) {\n            for (const trigger of bot.triggers) {\n                if (lowerBody.includes(trigger.toLowerCase())) {\n                    return bot;\n                }\n            }\n        }\n\n        return undefined;\n    }\n\n    /**\n     * Extract the query from a comment body\n     */\n    extractQuery(body: string, bot: Bot): string {\n        let query = body;\n\n        // Remove the trigger (case-insensitive)\n        const lowerBody = body.toLowerCase();\n        for (const trigger of bot.triggers) {\n            const lowerTrigger = trigger.toLowerCase();\n            if (lowerBody.includes(lowerTrigger)) {\n                // Find the actual case version in the body to replace it\n                const index = lowerBody.indexOf(lowerTrigger);\n                if (index !== -1) {\n                    query = query.slice(0, index) + query.slice(index + trigger.length);\n                }\n            }\n        }\n\n        return query.trim();\n    }\n\n    /**\n     * Route a comment to the appropriate bot\n     */\n    async route(ctx: Omit<BotContext, 'query'>): Promise<BotResponse> {\n        const bot = this.findBot(ctx.body);\n\n        if (!bot) {\n            return {\n                body: '',\n                handled: false,\n            };\n        }\n\n        const query = this.extractQuery(ctx.body, bot);\n\n        try {\n            return await bot.handle({ ...ctx, query });\n        } catch (error) {\n            return {\n                body: `âŒ **@${bot.name}** encountered an error: ${error instanceof Error ? error.message : 'Unknown error'}`,\n                handled: true,\n                postComment: true,\n                error: error instanceof Error ? error.message : 'Unknown error',\n            };\n        }\n    }\n\n    /**\n     * Get all registered bots\n     */\n    getBots(): Bot[] {\n        return Array.from(this.bots.values());\n    }\n\n    /**\n     * Get help text for all bots\n     */\n    getHelp(): string {\n        const lines = ['## ðŸ¤– Available Bots\\n'];\n\n        for (const bot of this.bots.values()) {\n            lines.push(`### @${bot.name}`);\n            lines.push(`Triggers: ${bot.triggers.map((t) => `\\`${t}\\``).join(', ')}\\n`);\n        }\n\n        return lines.join('\\n');\n    }\n}\n\n/**\n * Create a pre-configured bot router with all triage bots\n */\nexport async function createBotRouter(): Promise<BotRouter> {\n    const router = new BotRouter();\n\n    // Dynamically import bots to avoid circular dependencies\n    const { SageBot } = await import('./sage.js');\n    const { CuratorBot } = await import('./curator.js');\n    const { FixerBot } = await import('./fixer.js');\n    const { HarvesterBot } = await import('./harvester.js');\n    const { GuardianBot } = await import('./guardian.js');\n\n    router.register(new SageBot());\n    router.register(new CuratorBot());\n    router.register(new FixerBot());\n    router.register(new HarvesterBot());\n    router.register(new GuardianBot());\n\n    return router;\n}\n"],"mappings":";AAwDO,IAAM,YAAN,MAAgB;AAAA,EACX,OAAyB,oBAAI,IAAI;AAAA;AAAA;AAAA;AAAA,EAKzC,SAAS,KAAgB;AACrB,SAAK,KAAK,IAAI,IAAI,MAAM,GAAG;AAAA,EAC/B;AAAA;AAAA;AAAA;AAAA,EAKA,QAAQ,MAA+B;AACnC,UAAM,YAAY,KAAK,YAAY;AAEnC,eAAW,OAAO,KAAK,KAAK,OAAO,GAAG;AAClC,iBAAW,WAAW,IAAI,UAAU;AAChC,YAAI,UAAU,SAAS,QAAQ,YAAY,CAAC,GAAG;AAC3C,iBAAO;AAAA,QACX;AAAA,MACJ;AAAA,IACJ;AAEA,WAAO;AAAA,EACX;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa,MAAc,KAAkB;AACzC,QAAI,QAAQ;AAGZ,UAAM,YAAY,KAAK,YAAY;AACnC,eAAW,WAAW,IAAI,UAAU;AAChC,YAAM,eAAe,QAAQ,YAAY;AACzC,UAAI,UAAU,SAAS,YAAY,GAAG;AAElC,cAAM,QAAQ,UAAU,QAAQ,YAAY;AAC5C,YAAI,UAAU,IAAI;AACd,kBAAQ,MAAM,MAAM,GAAG,KAAK,IAAI,MAAM,MAAM,QAAQ,QAAQ,MAAM;AAAA,QACtE;AAAA,MACJ;AAAA,IACJ;AAEA,WAAO,MAAM,KAAK;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,MAAM,KAAsD;AAC9D,UAAM,MAAM,KAAK,QAAQ,IAAI,IAAI;AAEjC,QAAI,CAAC,KAAK;AACN,aAAO;AAAA,QACH,MAAM;AAAA,QACN,SAAS;AAAA,MACb;AAAA,IACJ;AAEA,UAAM,QAAQ,KAAK,aAAa,IAAI,MAAM,GAAG;AAE7C,QAAI;AACA,aAAO,MAAM,IAAI,OAAO,EAAE,GAAG,KAAK,MAAM,CAAC;AAAA,IAC7C,SAAS,OAAO;AACZ,aAAO;AAAA,QACH,MAAM,aAAQ,IAAI,IAAI,4BAA4B,iBAAiB,QAAQ,MAAM,UAAU,eAAe;AAAA,QAC1G,SAAS;AAAA,QACT,aAAa;AAAA,QACb,OAAO,iBAAiB,QAAQ,MAAM,UAAU;AAAA,MACpD;AAAA,IACJ;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKA,UAAiB;AACb,WAAO,MAAM,KAAK,KAAK,KAAK,OAAO,CAAC;AAAA,EACxC;AAAA;AAAA;AAAA;AAAA,EAKA,UAAkB;AACd,UAAM,QAAQ,CAAC,+BAAwB;AAEvC,eAAW,OAAO,KAAK,KAAK,OAAO,GAAG;AAClC,YAAM,KAAK,QAAQ,IAAI,IAAI,EAAE;AAC7B,YAAM,KAAK,aAAa,IAAI,SAAS,IAAI,CAAC,MAAM,KAAK,CAAC,IAAI,EAAE,KAAK,IAAI,CAAC;AAAA,CAAI;AAAA,IAC9E;AAEA,WAAO,MAAM,KAAK,IAAI;AAAA,EAC1B;AACJ;AAKA,eAAsB,kBAAsC;AACxD,QAAM,SAAS,IAAI,UAAU;AAG7B,QAAM,EAAE,QAAQ,IAAI,MAAM,OAAO,WAAW;AAC5C,QAAM,EAAE,WAAW,IAAI,MAAM,OAAO,cAAc;AAClD,QAAM,EAAE,SAAS,IAAI,MAAM,OAAO,YAAY;AAC9C,QAAM,EAAE,aAAa,IAAI,MAAM,OAAO,gBAAgB;AACtD,QAAM,EAAE,YAAY,IAAI,MAAM,OAAO,eAAe;AAEpD,SAAO,SAAS,IAAI,QAAQ,CAAC;AAC7B,SAAO,SAAS,IAAI,WAAW,CAAC;AAChC,SAAO,SAAS,IAAI,SAAS,CAAC;AAC9B,SAAO,SAAS,IAAI,aAAa,CAAC;AAClC,SAAO,SAAS,IAAI,YAAY,CAAC;AAEjC,SAAO;AACX;","names":[]}