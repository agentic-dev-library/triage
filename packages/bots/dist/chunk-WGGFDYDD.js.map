{"version":3,"sources":["../src/sage.ts"],"sourcesContent":["/**\n * @sage Bot - Q&A, task decomposition, and agent routing\n */\n\nimport type { Bot, BotContext, BotResponse } from './router.js';\nimport { sage, decomposeTask, routeToAgent, unblock } from '@agentic/triage-core';\n\nexport class SageBot implements Bot {\n    name = 'sage';\n    triggers = ['@sage', '/sage'];\n\n    async handle(ctx: BotContext): Promise<BotResponse> {\n        if (!ctx.query) {\n            return {\n                body: `üîÆ **@sage** - How can I help?\n\nUsage:\n- \\`@sage <question>\\` - Ask a question\n- \\`@sage decompose <task>\\` - Break down a task\n- \\`@sage route <task>\\` - Get agent recommendation\n- \\`@sage unblock <blocker>\\` - Get help with a blocker`,\n                handled: true,\n                postComment: true,\n            };\n        }\n\n        const query = ctx.query.toLowerCase();\n\n        try {\n            let result: any;\n            let responseBody: string;\n\n            if (query.startsWith('decompose ')) {\n                const task = ctx.query.replace(/^decompose\\s+/i, '');\n                if (ctx.model) {\n                    result = await decomposeTask(task, ctx.model);\n                    responseBody = this.formatDecomposition(result);\n                } else {\n                    responseBody = '‚ùå No AI model configured for decomposition';\n                }\n            } else if (query.startsWith('route ')) {\n                const task = ctx.query.replace(/^route\\s+/i, '');\n                if (ctx.model) {\n                    result = await routeToAgent(task, ctx.model);\n                    responseBody = this.formatRouting(result);\n                } else {\n                    responseBody = '‚ùå No AI model configured for routing';\n                }\n            } else if (query.startsWith('unblock ')) {\n                const blocker = ctx.query.replace(/^unblock\\s+/i, '');\n                if (ctx.model) {\n                    result = await unblock(blocker, ctx.model);\n                    responseBody = this.formatUnblock(result);\n                } else {\n                    responseBody = '‚ùå No AI model configured for unblock';\n                }\n            } else {\n                // Default: answer question\n                if (ctx.model) {\n                    result = await sage(ctx.query, ctx.model);\n                    responseBody = this.formatAnswer(result);\n                } else {\n                    // Fallback to pattern-based response\n                    responseBody = this.patternBasedResponse(ctx.query);\n                }\n            }\n\n            return {\n                body: responseBody,\n                handled: true,\n                postComment: true,\n            };\n        } catch (error) {\n            return {\n                body: `‚ùå **@sage** error: ${error instanceof Error ? error.message : 'Unknown error'}`,\n                handled: true,\n                postComment: true,\n                error: error instanceof Error ? error.message : 'Unknown error',\n            };\n        }\n    }\n\n    private formatAnswer(result: any): string {\n        let body = `üîÆ **@sage**\\n\\n${result.answer || result}`;\n\n        if (result.agentRecommendation) {\n            body += `\\n\\nüìå **Recommended**: \\`@${result.agentRecommendation.agent}\\``;\n            body += `\\n_${result.agentRecommendation.reason}_`;\n        }\n\n        if (result.confidence) {\n            body += `\\n\\n_(Confidence: ${Math.round(result.confidence * 100)}%)_`;\n        }\n\n        return body;\n    }\n\n    private formatDecomposition(result: any): string {\n        let body = 'üìã **@sage** Task Decomposition\\n\\n';\n\n        if (result.subtasks) {\n            for (const task of result.subtasks) {\n                body += `### ${task.id}: ${task.title}\\n`;\n                body += `- **Agent**: \\`@${task.agent}\\`\\n`;\n                body += `- **Priority**: ${task.priority}\\n`;\n                body += `- **Effort**: ${task.effort}\\n`;\n                body += `- ${task.description}\\n\\n`;\n            }\n        }\n\n        return body;\n    }\n\n    private formatRouting(result: any): string {\n        let body = 'üéØ **@sage** Agent Routing\\n\\n';\n        body += `**Recommended Agent**: \\`@${result.agent}\\`\\n\\n`;\n        body += `**Reason**: ${result.reason}\\n\\n`;\n        body += `**Instructions**: ${result.instructions}\\n\\n`;\n        body += `_(Confidence: ${Math.round(result.confidence * 100)}%)_`;\n\n        return body;\n    }\n\n    private formatUnblock(result: any): string {\n        let body = 'üîì **@sage** Unblock Analysis\\n\\n';\n        body += `**Diagnosis**: ${result.diagnosis}\\n\\n`;\n        body += `**Root Cause**: ${result.rootCause}\\n\\n`;\n        body += `‚ö° **Immediate Action**: ${result.immediateAction}\\n\\n`;\n\n        if (result.needsHuman) {\n            body += `‚ö†Ô∏è **Human intervention required**: ${result.escalationReason}\\n`;\n        }\n\n        return body;\n    }\n\n    private patternBasedResponse(query: string): string {\n        // Simple pattern matching when no LLM is available\n        const lowerQuery = query.toLowerCase();\n\n        if (lowerQuery.includes('how') && lowerQuery.includes('test')) {\n            return `üîÆ **@sage**\n\nTo run tests, typically use:\n- \\`npm test\\` or \\`pnpm test\\` for Node.js\n- \\`pytest\\` for Python\n- \\`go test ./...\\` for Go\n\nCheck the project's README or package.json for specific test commands.`;\n        }\n\n        if (lowerQuery.includes('deploy') || lowerQuery.includes('release')) {\n            return `üîÆ **@sage**\n\nFor deployments:\n1. Ensure all tests pass\n2. Update version using conventional commits\n3. Create a release PR\n4. Merge and let CI handle the release\n\nCheck \\`.github/workflows/\\` for specific deployment workflows.`;\n        }\n\n        return `üîÆ **@sage**\n\nI can help with:\n- \\`@sage <question>\\` - Ask me anything\n- \\`@sage decompose <task>\\` - Break down into subtasks\n- \\`@sage route <task>\\` - Get the best agent for the job\n- \\`@sage unblock <issue>\\` - Get help with blockers\n\n_(AI-powered responses require model configuration)_`;\n    }\n}\n"],"mappings":"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","names":[]}