{"version":3,"sources":["../src/webhook.ts"],"sourcesContent":["/**\n * Webhook Handler - Process GitHub webhook events and route to bots\n */\n\nimport type { LanguageModel } from 'ai';\nimport { createBotRouter, type BotContext, type BotResponse } from './router.js';\nimport { commentOnIssue, commentOnPR } from '@agentic/triage-trackers';\n\nexport interface WebhookEvent {\n    action: string;\n    issue?: {\n        number: number;\n        title: string;\n        body: string;\n        pull_request?: unknown;\n    };\n    pull_request?: {\n        number: number;\n        title: string;\n        body: string;\n    };\n    comment?: {\n        body: string;\n        user: {\n            login: string;\n        };\n    };\n    repository: {\n        name: string;\n        owner: {\n            login: string;\n        };\n    };\n    sender: {\n        login: string;\n    };\n}\n\nexport interface WebhookHandlerOptions {\n    /** AI model to use for responses */\n    model?: LanguageModel;\n    /** GitHub token for API calls */\n    token?: string;\n    /** Whether to actually post comments (false for testing) */\n    dryRun?: boolean;\n}\n\nexport class WebhookHandler {\n    private options: WebhookHandlerOptions;\n\n    constructor(options: WebhookHandlerOptions = {}) {\n        this.options = options;\n    }\n\n    /**\n     * Handle an incoming webhook event\n     */\n    async handle(event: WebhookEvent): Promise<BotResponse | null> {\n        // Only handle issue_comment and pull_request_review_comment events\n        if (event.action !== 'created' || !event.comment) {\n            return null;\n        }\n\n        const body = event.comment.body;\n\n        // Create router\n        const router = await createBotRouter();\n\n        // Check if any bot should handle this\n        const bot = router.findBot(body);\n        if (!bot) {\n            return null;\n        }\n\n        // Build context\n        const isPR = !!event.issue?.pull_request || !!event.pull_request;\n        const number = event.issue?.number || event.pull_request?.number || 0;\n\n        const ctx: Omit<BotContext, 'query'> = {\n            body,\n            number,\n            isPR,\n            owner: event.repository.owner.login,\n            repo: event.repository.name,\n            author: event.sender.login,\n            model: this.options.model,\n            token: this.options.token,\n        };\n\n        // Route to bot\n        const response = await router.route(ctx);\n\n        // Post comment if requested\n        if (response.handled && response.postComment && response.body && !this.options.dryRun) {\n            try {\n                if (isPR) {\n                    commentOnPR(number, response.body);\n                } else {\n                    commentOnIssue(number, response.body);\n                }\n            } catch (error) {\n                console.error('Failed to post comment:', error);\n            }\n        }\n\n        return response;\n    }\n\n    /**\n     * Verify webhook signature (for production use)\n     */\n    static verifySignature(payload: string, signature: string, secret: string): boolean {\n        const crypto = require('node:crypto');\n        const expected = `sha256=${crypto.createHmac('sha256', secret).update(payload).digest('hex')}`;\n\n        return crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(expected));\n    }\n}\n\n/**\n * Create a simple HTTP server for webhooks (for testing/local dev)\n */\nexport async function createWebhookServer(port: number, options: WebhookHandlerOptions = {}): Promise<void> {\n    const http = require('node:http');\n    const handler = new WebhookHandler(options);\n\n    const server = http.createServer(async (req: any, res: any) => {\n        if (req.method !== 'POST' || req.url !== '/webhook') {\n            res.writeHead(404);\n            res.end('Not Found');\n            return;\n        }\n\n        let body = '';\n        req.on('data', (chunk: string) => {\n            body += chunk;\n        });\n\n        req.on('end', async () => {\n            try {\n                const event = JSON.parse(body) as WebhookEvent;\n                const response = await handler.handle(event);\n\n                res.writeHead(200, { 'Content-Type': 'application/json' });\n                res.end(JSON.stringify({ handled: response?.handled ?? false }));\n            } catch (error) {\n                console.error('Webhook error:', error);\n                res.writeHead(500);\n                res.end('Internal Server Error');\n            }\n        });\n    });\n\n    server.listen(port, () => {\n        console.log(`ðŸ¤– Triage Bots webhook server running on port ${port}`);\n        console.log(`   POST http://localhost:${port}/webhook`);\n    });\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAMA,SAAS,gBAAgB,mBAAmB;AAyCrC,IAAM,iBAAN,MAAqB;AAAA,EAChB;AAAA,EAER,YAAY,UAAiC,CAAC,GAAG;AAC7C,SAAK,UAAU;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,OAAO,OAAkD;AAE3D,QAAI,MAAM,WAAW,aAAa,CAAC,MAAM,SAAS;AAC9C,aAAO;AAAA,IACX;AAEA,UAAM,OAAO,MAAM,QAAQ;AAG3B,UAAM,SAAS,MAAM,gBAAgB;AAGrC,UAAM,MAAM,OAAO,QAAQ,IAAI;AAC/B,QAAI,CAAC,KAAK;AACN,aAAO;AAAA,IACX;AAGA,UAAM,OAAO,CAAC,CAAC,MAAM,OAAO,gBAAgB,CAAC,CAAC,MAAM;AACpD,UAAM,SAAS,MAAM,OAAO,UAAU,MAAM,cAAc,UAAU;AAEpE,UAAM,MAAiC;AAAA,MACnC;AAAA,MACA;AAAA,MACA;AAAA,MACA,OAAO,MAAM,WAAW,MAAM;AAAA,MAC9B,MAAM,MAAM,WAAW;AAAA,MACvB,QAAQ,MAAM,OAAO;AAAA,MACrB,OAAO,KAAK,QAAQ;AAAA,MACpB,OAAO,KAAK,QAAQ;AAAA,IACxB;AAGA,UAAM,WAAW,MAAM,OAAO,MAAM,GAAG;AAGvC,QAAI,SAAS,WAAW,SAAS,eAAe,SAAS,QAAQ,CAAC,KAAK,QAAQ,QAAQ;AACnF,UAAI;AACA,YAAI,MAAM;AACN,sBAAY,QAAQ,SAAS,IAAI;AAAA,QACrC,OAAO;AACH,yBAAe,QAAQ,SAAS,IAAI;AAAA,QACxC;AAAA,MACJ,SAAS,OAAO;AACZ,gBAAQ,MAAM,2BAA2B,KAAK;AAAA,MAClD;AAAA,IACJ;AAEA,WAAO;AAAA,EACX;AAAA;AAAA;AAAA;AAAA,EAKA,OAAO,gBAAgB,SAAiB,WAAmB,QAAyB;AAChF,UAAM,SAAS,UAAQ,QAAa;AACpC,UAAM,WAAW,UAAU,OAAO,WAAW,UAAU,MAAM,EAAE,OAAO,OAAO,EAAE,OAAO,KAAK,CAAC;AAE5F,WAAO,OAAO,gBAAgB,OAAO,KAAK,SAAS,GAAG,OAAO,KAAK,QAAQ,CAAC;AAAA,EAC/E;AACJ;AAKA,eAAsB,oBAAoB,MAAc,UAAiC,CAAC,GAAkB;AACxG,QAAM,OAAO,UAAQ,MAAW;AAChC,QAAM,UAAU,IAAI,eAAe,OAAO;AAE1C,QAAM,SAAS,KAAK,aAAa,OAAO,KAAU,QAAa;AAC3D,QAAI,IAAI,WAAW,UAAU,IAAI,QAAQ,YAAY;AACjD,UAAI,UAAU,GAAG;AACjB,UAAI,IAAI,WAAW;AACnB;AAAA,IACJ;AAEA,QAAI,OAAO;AACX,QAAI,GAAG,QAAQ,CAAC,UAAkB;AAC9B,cAAQ;AAAA,IACZ,CAAC;AAED,QAAI,GAAG,OAAO,YAAY;AACtB,UAAI;AACA,cAAM,QAAQ,KAAK,MAAM,IAAI;AAC7B,cAAM,WAAW,MAAM,QAAQ,OAAO,KAAK;AAE3C,YAAI,UAAU,KAAK,EAAE,gBAAgB,mBAAmB,CAAC;AACzD,YAAI,IAAI,KAAK,UAAU,EAAE,SAAS,UAAU,WAAW,MAAM,CAAC,CAAC;AAAA,MACnE,SAAS,OAAO;AACZ,gBAAQ,MAAM,kBAAkB,KAAK;AACrC,YAAI,UAAU,GAAG;AACjB,YAAI,IAAI,uBAAuB;AAAA,MACnC;AAAA,IACJ,CAAC;AAAA,EACL,CAAC;AAED,SAAO,OAAO,MAAM,MAAM;AACtB,YAAQ,IAAI,wDAAiD,IAAI,EAAE;AACnE,YAAQ,IAAI,4BAA4B,IAAI,UAAU;AAAA,EAC1D,CAAC;AACL;","names":[]}