{"version":3,"sources":["../src/fixer.ts"],"sourcesContent":["/**\n * @fixer Bot - CI failure analysis and fix suggestions\n */\n\nimport type { Bot, BotContext, BotResponse } from './router.js';\n\nexport class FixerBot implements Bot {\n    name = 'fixer';\n    triggers = ['@fixer', '/fixer', '/fix'];\n\n    async handle(ctx: BotContext): Promise<BotResponse> {\n        if (!ctx.isPR) {\n            return {\n                body: `ðŸ”§ **@fixer** works best on Pull Requests with CI failures.\n\nUse on a PR to analyze failing checks.`,\n                handled: true,\n                postComment: true,\n            };\n        }\n\n        // Analyze the query or issue body for error patterns\n        const analysis = this.analyzeErrors(ctx.body, ctx.query);\n\n        return {\n            body: this.formatAnalysis(analysis),\n            handled: true,\n            postComment: true,\n        };\n    }\n\n    private analyzeErrors(\n        body: string,\n        query: string\n    ): {\n        diagnosis: string;\n        fix: string;\n        severity: string;\n        canAutoFix: boolean;\n        commands: string[];\n    } {\n        const combined = `${body} ${query}`.toLowerCase();\n        const commands: string[] = [];\n\n        // TypeScript errors\n        if (combined.match(/type.*error|typescript|ts\\d{4}|cannot find name/)) {\n            return {\n                diagnosis: 'TypeScript type errors detected',\n                fix: 'Fix type annotations and imports',\n                severity: 'high',\n                canAutoFix: true,\n                commands: ['pnpm typecheck', 'pnpm lint:fix'],\n            };\n        }\n\n        // Linting errors\n        if (combined.match(/eslint|lint|biome|prettier|formatting/)) {\n            return {\n                diagnosis: 'Linting/formatting errors detected',\n                fix: 'Run the linter with auto-fix',\n                severity: 'medium',\n                canAutoFix: true,\n                commands: ['pnpm lint:fix', 'pnpm format'],\n            };\n        }\n\n        // Test failures\n        if (combined.match(/test.*fail|expect|assert|vitest|jest|pytest/)) {\n            return {\n                diagnosis: 'Test failures detected',\n                fix: 'Review and fix failing tests',\n                severity: 'high',\n                canAutoFix: false,\n                commands: ['pnpm test', 'pnpm test:coverage'],\n            };\n        }\n\n        // Build errors\n        if (combined.match(/build.*fail|compile|bundle|webpack|vite|tsup/)) {\n            return {\n                diagnosis: 'Build errors detected',\n                fix: 'Fix compilation issues',\n                severity: 'high',\n                canAutoFix: false,\n                commands: ['pnpm build'],\n            };\n        }\n\n        // Module not found\n        if (combined.match(/cannot find module|module not found|import.*error/)) {\n            return {\n                diagnosis: 'Missing dependencies or imports',\n                fix: 'Install dependencies and check import paths',\n                severity: 'high',\n                canAutoFix: true,\n                commands: ['pnpm install', 'pnpm build'],\n            };\n        }\n\n        // Permission errors\n        if (combined.match(/permission denied|eacces|eperm/)) {\n            return {\n                diagnosis: 'Permission issues',\n                fix: 'Check file permissions or CI configuration',\n                severity: 'medium',\n                canAutoFix: false,\n                commands: [],\n            };\n        }\n\n        // Timeout\n        if (combined.match(/timeout|timed out|deadline exceeded/)) {\n            return {\n                diagnosis: 'Timeout error',\n                fix: 'Optimize slow operations or increase timeout',\n                severity: 'medium',\n                canAutoFix: false,\n                commands: [],\n            };\n        }\n\n        // Memory\n        if (combined.match(/out of memory|heap|oom|memory limit/)) {\n            return {\n                diagnosis: 'Memory limit exceeded',\n                fix: 'Optimize memory usage or increase limits',\n                severity: 'high',\n                canAutoFix: false,\n                commands: [],\n            };\n        }\n\n        return {\n            diagnosis: 'CI failure - requires investigation',\n            fix: 'Review the full logs for details',\n            severity: 'medium',\n            canAutoFix: false,\n            commands: ['gh run view --log-failed'],\n        };\n    }\n\n    private formatAnalysis(analysis: {\n        diagnosis: string;\n        fix: string;\n        severity: string;\n        canAutoFix: boolean;\n        commands: string[];\n    }): string {\n        const severityEmoji: Record<string, string> = {\n            critical: 'ðŸ”´',\n            high: 'ðŸŸ ',\n            medium: 'ðŸŸ¡',\n            low: 'âšª',\n        };\n\n        let body = `ðŸ”§ **@fixer** CI Analysis\n\n${severityEmoji[analysis.severity] || 'âšª'} **Diagnosis**: ${analysis.diagnosis}\n\nðŸ’¡ **Suggested Fix**: ${analysis.fix}`;\n\n        if (analysis.commands.length > 0) {\n            body += '\\n\\n**Try these commands**:\\n```bash\\n';\n            body += analysis.commands.join('\\n');\n            body += '\\n```';\n        }\n\n        if (analysis.canAutoFix) {\n            body += '\\n\\nâœ… This can likely be auto-fixed. Use `@cascade fix` to attempt.';\n        }\n\n        return body;\n    }\n}\n"],"mappings":"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","names":[]}