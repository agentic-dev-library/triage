{"version":3,"sources":["../src/github.ts"],"sourcesContent":["/**\n * GitHub Issues Provider\n */\n\nimport { execFileSync } from 'node:child_process';\nimport {\n    type CreateIssueOptions,\n    type GitHubProviderConfig,\n    type IssuePriority,\n    type IssueType,\n    type ListIssuesOptions,\n    normalizePriority,\n    normalizeType,\n    type ProviderStats,\n    priorityToNumber,\n    type ReadyWork,\n    type TriageIssue,\n    type TriageProvider,\n    type UpdateIssueOptions,\n} from './types.js';\n\nexport class GitHubProvider implements TriageProvider {\n    readonly name = 'github';\n    readonly displayName = 'GitHub Issues';\n\n    private repo: string;\n    private token?: string;\n\n    constructor(config: GitHubProviderConfig) {\n        this.repo = config.repo;\n        this.token = config.token || process.env.GITHUB_TOKEN || process.env.GH_TOKEN;\n    }\n\n    async isReady(): Promise<boolean> {\n        try {\n            this.gh(['repo', 'view', this.repo, '--json', 'name']);\n            return true;\n        } catch {\n            return false;\n        }\n    }\n\n    async createIssue(options: CreateIssueOptions): Promise<TriageIssue> {\n        const args = ['issue', 'create', '--repo', this.repo];\n        args.push('--title', options.title);\n        if (options.description) args.push('--body', options.description);\n\n        const labels = [...(options.labels || [])];\n        if (options.type) labels.push(`type:${options.type}`);\n        if (options.priority) labels.push(`priority:${options.priority}`);\n\n        if (labels.length > 0) args.push('--label', labels.join(','));\n        if (options.assignee) args.push('--assignee', options.assignee);\n\n        const result = this.gh(args);\n        const match = result.match(/\\/issues\\/(\\d+)/);\n        const id = match ? match[1] : result.trim();\n\n        const issue = await this.getIssue(id);\n        if (!issue) throw new Error(`Failed to retrieve created issue ${id}`);\n        return issue;\n    }\n\n    async getIssue(id: string): Promise<TriageIssue | null> {\n        try {\n            const result = this.gh([\n                'issue',\n                'view',\n                id,\n                '--repo',\n                this.repo,\n                '--json',\n                'number,title,body,state,labels,assignees,createdAt,updatedAt,closedAt,url',\n            ]);\n            const data = JSON.parse(result);\n            return this.mapGitHubIssue(data);\n        } catch {\n            return null;\n        }\n    }\n\n    async updateIssue(id: string, options: UpdateIssueOptions): Promise<TriageIssue> {\n        const args = ['issue', 'edit', id, '--repo', this.repo];\n        if (options.title) args.push('--title', options.title);\n        if (options.description) args.push('--body', options.description);\n\n        if (options.labels) args.push('--add-label', options.labels.join(','));\n        if (options.assignee) args.push('--add-assignee', options.assignee);\n        if (options.priority) args.push('--add-label', `priority:${options.priority}`);\n        if (options.type) args.push('--add-label', `type:${options.type}`);\n\n        if (args.length > 4) this.gh(args);\n\n        if (options.status === 'closed') {\n            this.gh(['issue', 'close', id, '--repo', this.repo]);\n        } else if (options.status === 'open') {\n            this.gh(['issue', 'reopen', id, '--repo', this.repo]);\n        }\n\n        const issue = await this.getIssue(id);\n        if (!issue) throw new Error(`Failed to retrieve updated issue ${id}`);\n        return issue;\n    }\n\n    async closeIssue(id: string, reason?: string): Promise<TriageIssue> {\n        const args = ['issue', 'close', id, '--repo', this.repo];\n        if (reason) args.push('--comment', reason);\n        this.gh(args);\n        const issue = await this.getIssue(id);\n        if (!issue) throw new Error(`Failed to retrieve closed issue ${id}`);\n        return issue;\n    }\n\n    async reopenIssue(id: string, reason?: string): Promise<TriageIssue> {\n        const args = ['issue', 'reopen', id, '--repo', this.repo];\n        if (reason) args.push('--comment', reason);\n        this.gh(args);\n        const issue = await this.getIssue(id);\n        if (!issue) throw new Error(`Failed to retrieve reopened issue ${id}`);\n        return issue;\n    }\n\n    async listIssues(options?: ListIssuesOptions): Promise<TriageIssue[]> {\n        const args = [\n            'issue',\n            'list',\n            '--repo',\n            this.repo,\n            '--json',\n            'number,title,body,state,labels,assignees,createdAt,updatedAt,closedAt,url',\n        ];\n\n        if (options?.status) {\n            const statuses = Array.isArray(options.status) ? options.status : [options.status];\n            if (statuses.includes('closed')) args.push('--state', 'closed');\n            else if (statuses.every((s) => s !== 'closed')) args.push('--state', 'open');\n            else args.push('--state', 'all');\n        }\n\n        if (options?.limit) args.push('--limit', String(options.limit));\n        if (options?.assignee) args.push('--assignee', options.assignee);\n\n        const result = this.gh(args);\n        const data = JSON.parse(result);\n        return data.map((item: any) => this.mapGitHubIssue(item));\n    }\n\n    async getReadyWork(options?: { limit?: number; priority?: IssuePriority }): Promise<ReadyWork[]> {\n        const issues = await this.listIssues({\n            status: 'open',\n            limit: options?.limit || 20,\n            priority: options?.priority,\n        });\n        return issues\n            .filter((i) => !i.labels.some((l) => l.toLowerCase().includes('blocked')))\n            .sort((a, b) => priorityToNumber(a.priority) - priorityToNumber(b.priority))\n            .map((issue) => ({ issue }));\n    }\n\n    async getBlockedIssues(): Promise<TriageIssue[]> {\n        const issues = await this.listIssues({ status: 'open' });\n        return issues.filter((i) => i.labels.some((l) => l.toLowerCase().includes('blocked')));\n    }\n\n    async searchIssues(query: string, options?: ListIssuesOptions): Promise<TriageIssue[]> {\n        return this.listIssues({ ...options, titleContains: query });\n    }\n\n    async addLabels(id: string, labels: string[]): Promise<void> {\n        this.gh(['issue', 'edit', id, '--repo', this.repo, '--add-label', labels.join(',')]);\n    }\n\n    async removeLabels(id: string, labels: string[]): Promise<void> {\n        this.gh(['issue', 'edit', id, '--repo', this.repo, '--remove-label', labels.join(',')]);\n    }\n\n    async getStats(): Promise<ProviderStats> {\n        const issues = await this.listIssues({ limit: 1000 });\n        const stats: ProviderStats = {\n            total: issues.length,\n            open: issues.filter((i) => i.status === 'open').length,\n            inProgress: issues.filter((i) => i.status === 'in_progress').length,\n            blocked: issues.filter((i) => i.status === 'blocked').length,\n            closed: issues.filter((i) => i.status === 'closed').length,\n            byPriority: { critical: 0, high: 0, medium: 0, low: 0, backlog: 0 },\n            byType: { bug: 0, feature: 0, task: 0, epic: 0, chore: 0, docs: 0 },\n        };\n\n        for (const issue of issues) {\n            stats.byPriority[issue.priority]++;\n            stats.byType[issue.type]++;\n        }\n        return stats;\n    }\n\n    private gh(args: string[]): string {\n        const env = { ...process.env };\n        if (this.token) env.GH_TOKEN = this.token;\n        return execFileSync('gh', args, { encoding: 'utf-8', env }).trim();\n    }\n\n    private mapGitHubIssue(data: any): TriageIssue {\n        const labels = (data.labels || []).map((l: any) => (typeof l === 'string' ? l : l.name));\n        let priority: IssuePriority = 'medium';\n        let type: IssueType = 'task';\n\n        for (const label of labels) {\n            if (label.startsWith('priority:')) priority = normalizePriority(label.replace('priority:', ''));\n            if (label.startsWith('type:')) type = normalizeType(label.replace('type:', ''));\n        }\n\n        return {\n            id: String(data.number),\n            title: data.title,\n            description: data.body || undefined,\n            status: data.state === 'closed' ? 'closed' : 'open',\n            priority,\n            type,\n            labels: labels.filter((l: string) => !l.startsWith('priority:') && !l.startsWith('type:')),\n            assignee: data.assignees?.[0]?.login,\n            createdAt: data.createdAt,\n            updatedAt: data.updatedAt,\n            closedAt: data.closedAt || undefined,\n            url: data.url,\n            metadata: { raw: data },\n        };\n    }\n}\n"],"mappings":"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","names":[]}